{% extends "site-base.html" %}

{% load static %}
{% load account %}
{% load i18n %}

{% block head_title %}{% trans "Weekly Timesheet" %}{% endblock %}
{% block extra_head %}
  <script
  src="https://code.jquery.com/jquery-3.3.1.js"
  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
  crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.0/moment.js"></script>
  <script src="{% static 'timesheets/jquery.formset.js' %}" type="text/javascript"></script>
  <script type="text/javascript">
    $(function() {
      $('#timetable tbody tr').formset({
        prefix: '{{ timesheet_formset.prefix }}',
        formCssClass: 'dynamic-timesheet_formset'
      });
    })
  </script>
{% endblock %}

{% block content %}
<div class="w3-container w3-margin-top">
<header class="w3-container">
  <h1>{% trans "Week " %}{{week}}-{{year}}{% trans " timesheet" %}</h1>
  <h3>{% trans "Starts " %} {{week_start|date:"l, jS F, Y"}}</h3>
</header>
{{week_start}}
<form class="w3-container w3-card-4" action="" method="post">
  {% csrf_token %}{{ timesheet_formset.management_form }}
  <br/>
  <table id='timetable' class="w3-table-all w3-hoverable w3-grey">
    <thead>
      <tr class='w3-grey'>
        <th>Project</th>
        <th>Task</th>
        <th id="head0">Mon</th>
        <th id="head1">Tue</th>
        <th id="head2">Wed</th>
        <th id="head3">Thu</th>
        <th id="head4">Fri</th>
        <th id="head5">Sat</th>
        <th id="head6">Sun</th>
        <th>-</th>
      </tr>
    </thead>
    <tbody onchange="calculateTotals()">  
        {% for form in timesheet_formset %}
        <tr>
          <td>{% for fld in form.hidden_fields %}{{ fld }}{% endfor %}
            {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
          {{form.project}}</td>
          <td>{{form.task}}</td>
          <td>{{form.mon}}</td>
          <td>{{form.tue}}</td>
          <td>{{form.wed}}</td>
          <td>{{form.thu}}</td>
          <td>{{form.fri}}</td>
          <td>{{form.sat}}</td>
          <td>{{form.sun}}</td>
          <td></td>
        </tr>       
        {% endfor %}
    </tbody>
    <tfoot>
      <tr class='w3-grey'>
        <td></td>
        <td style="fontSize:16px;"><b>TOTALS:</b></td>
        <td id="id_mon_total"></td>
        <td id="id_tue_total"></td>
        <td id="id_wed_total"></td>
        <td id="id_thu_total"></td>
        <td id="id_fri_total"></td>
        <td id="id_sat_total"></td>
        <td id="id_sun_total"></td>
        <td id="id_total_timesheet_duration"><b> hrs</b></td>
      </tr>
    </tfoot>
  </table>
  <a class="w3-button w3-section w3-red w3-ripple" href="{% url 'timesheets:timelog-list' %}">{% trans "Cancel" %}</a>
  <button class="primaryAction w3-button w3-section w3-blue w3-ripple" type="submit">{% trans "Save" %}</button>
</form>
</div>

{% block extra_body %}
<script>
function calculateTotals() {
    var gt = 0.00;
    var d = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"];
    var dlen = d.length;
    var tf = document.getElementById("id_timesheet-TOTAL_FORMS").value;
    for (var w = 0; w < dlen; w++) {
        var daysubtotal = 0.00;
        for (var i = 0; i < tf; i++) {
            var dayrowelementID = "id_timesheet-"+i+"-"+d[w];
            var dayrowelement = parseFloat(document.getElementById(dayrowelementID).value);
            if (isNaN(dayrowelement)) {
                dayrowelement = 0.00;
            } else {
                daysubtotal += dayrowelement;
                gt += dayrowelement;
            } 
        }
        var dayelementID = "id_"+d[w]+"_total"; 
        document.getElementById(dayelementID).innerHTML = String(daysubtotal);
        var dstyle = document.getElementById(dayelementID); 
        dstyle.style.fontSize = '16px';
    }
    document.getElementById("id_total_timesheet_duration").innerHTML = gt+" hrs";
    var dstyle = document.getElementById("id_total_timesheet_duration"); 
    dstyle.style.fontSize = '16px';
}
window.onload=calculateTotals;
</script>
  <script>
  var i = 0;
  do {
      var eid = "head"+i;
      var d = new Date('{{week_start|date:"d M Y"}}');
      d.setDate(d.getDate() + i);
      document.getElementById(eid).innerHTML = moment(d).format('ddd Do MMM');
      i++;
  }
  while (i < 7);
  </script>
{% endblock %}

{% endblock %}