{% extends "site-base.html" %}

{% load static %}
{% load account %}
{% load i18n %}
{% load mathfilters %}

{% block head_title %}{% trans "Invoice" %}{% endblock %}


{% block content %}
<div class="w3-container w3-margin-top">
  <br>
	{% if invoice %}
    <div class="w3-container w3-card-4">
      <h1>{{ settings.trading_name }}</h1>
      <div class="w3-container w3-card-4">
        <br>
        <div class="w3-row">
          <div class="w3-col s1">
            <p><strong>Address:</strong></p>
          </div>
          <div class="w3-col s2">
            <p>{{ settings.address_line_1 }},<br>
            {{ settings.address_line_2 }},<br>
            {{ settings.address_line_3 }}.</p>
          </div>
          <div class="w3-col s1">
            <p><strong>Email:</strong></p>
            <p><strong>Phone:</strong></p>
          </div>
          <div class="w3-col s2">
            <p>{{ settings.email }}</p>
            <p>{{ settings.phone }}</p>
          </div>
           <div class="w3-col s1">
            <p><strong>Invoice Date:</strong></p>
            <p><strong>Tax Number:</strong></p>
          </div>
          <div class="w3-col s2">
            <p>{% now "d-M-Y" %}</p>
            <p>{{ settings.tax_number }}</p>
          </div>
          <div class="w3-col s3">
            <h2>Tax Invoice</h2>            
          </div>
        </div>
        <br>
      </div>
      <br>
      <div class="w3-container w3-card-4">
        <br>
        <div class="w3-row">
          <div class="w3-col s1">
            <p><strong>To:</strong></p>
          </div>
          <div class="w3-col s2">
            <p>customer address</p>
          </div>
          <div class="w3-col s1">
            <p><strong>Email:</strong></p>
            <p><strong>Phone:</strong></p>
          </div>
          <div class="w3-col s2">
            <p>cust email</p>
            <p>cust phone</p>
          </div>
           <div class="w3-col s1">
            <p><strong>Invoice Period:</strong></p>
            <p><strong>Project:</strong></p>
          </div>
          <div class="w3-col s2">
            <p>{{ week }}</p>
            <p>{{ p }}</p>
          </div>
          <div class="w3-col s3">
            <h2>{{p}}</h2>            
          </div>
        </div>
        <br>
      </div>
      <br>
      <table class="w3-table-all w3-hoverable w3-card-4 w3-grey">
        <thead>
          <tr class='w3-grey'>
            <th>Task</th>
            <th>Worker</th>
            <th>Hours worked</th>
            <th>Hourly rate</th>
            <th>Cost</th>
          </tr>
        </thead>
        <tbody>
         {% for timesheet in invoice %}
            {% for line in timesheet_lines %}
              {% if timesheet.name == line.timesheet.name %}
                <tr>
                  {% with line.mon|addition:line.tue|addition:line.wed|addition:line.thu|addition:line.fri|addition:line.sat|addition:line.sun as line_hours %}
                  <td>{{ line.task }}</td>
                  {% if timesheet.user.first_name and timesheet.user.last_name %}
                    <td>{{ timesheet.user.first_name }} {{ timesheet.user.last_name}}</td>
                  {% else %}
                    <td>{{ timesheet.user }}</td>
                  {% endif %}
                  <td>{{ line_hours }}</td>
                  {% for user in team %}
                    {% if timesheet.user == user.member %}
                      <td>${{ user.rate|floatformat:2 }}</td>
                      <td>$<span name="lp" id="lp-{{forloop.counter0}}">{{ line_hours|mul:user.rate|floatformat:2 }}</span></td>
                    {% endif %}
                  {% endfor %}
                  {% endwith %}
                </tr>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </tbody>
        <tfooter>
          <tr class="w3-topbar">
            <td></td>
            <td></td>
            <td></td>
            <td><strong>Subtotal:</strong></td>
            <td id="gross_total"><strong>$0.00</strong></td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td><strong>plus tax of {{ settings.tax_rate }}%:</strong></td>
            <td id="gst"><strong>$0.00</strong></td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="w3-topbar w3-bottombar"><strong>Invoice Total:</strong></td>
            <td class="w3-topbar w3-bottombar" id="net_total"><strong>$0.00</strong></td>
          </tr>
        </tfooter>
      </table>
      <br>
      <div class='w3-container w3-card-4'>
       <div class="w3-row">
          <div class="w3-col s3">
            <p><strong>Payment Terms:</strong></p>
          </div>
          <div class="w3-col s9">
            <p>{{ settings.payment_terms }}</p>
          </div>
        </div>
      </div>
      <a class="w3-button w3-large w3-section w3-blue w3-ripple w3-right" href="#">{% trans "Create PDF" %}</a>
    </div>
  {% else %}
    <p>No invoices.</p>
  {% endif %}
</div>

{% block extra_body %}
<script>
Number.prototype.formatMoney = function(c, d, t){
    var n = this, 
    c = isNaN(c = Math.abs(c)) ? 2 : c, 
    d = d == undefined ? "." : d, 
    t = t == undefined ? "," : t, 
    s = n < 0 ? "-" : "", 
    i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c))), 
    j = (j = i.length) > 3 ? j % 3 : 0;
   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
 };
var x = document.getElementsByName("lp");
var subTotal = 0.00;
var i = 0;
for (i = 0; i < x.length; i++) {
  var line_price = parseFloat(document.getElementsByName("lp")[i].innerHTML);
  subTotal += line_price;
}
document.getElementById("gross_total").innerHTML = "$"+ subTotal.formatMoney(2);
var GST = subTotal*0.15
document.getElementById("gst").innerHTML = "$"+ GST.formatMoney(2);
var NET = GST+subTotal
document.getElementById("net_total").innerHTML = "$"+ NET.formatMoney(2);
</script>
{% endblock %}


{% endblock %}